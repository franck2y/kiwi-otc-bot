<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OTC Bot avec RSI + EMA</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    select, button {
      font-size: 18px;
      padding: 10px;
      margin: 10px;
    }
    .signal-box {
      margin-top: 20px;
      font-size: 24px;
      font-weight: bold;
    }
    .countdown {
      color: #0f0;
      margin-top: 10px;
      font-size: 20px;
    }
    canvas {
      margin-top: 20px;
      background: #222;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h2>ü§ñ OTC Bot avec RSI + EMA</h2>
  <select id="pairSelect">
    <option value="EUR/USD">EUR/USD</option>
    <option value="GBP/JPY">GBP/JPY</option>
  </select>
  <button onclick="startBot()">D√©marrer le Bot</button>
  <div class="countdown" id="countdown">Prochain signal dans 60s</div>
  <div class="signal-box" id="signalBox"></div>
  <canvas id="chart" width="400" height="200"></canvas>

  <script>
    let interval;
    let seconds = 60;

    const ctx = document.getElementById('chart').getContext('2d');
    let chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Cours',
            data: [],
            borderColor: 'cyan',
            fill: false,
          },
          {
            label: 'RSI',
            data: [],
            borderColor: 'orange',
            fill: false,
          },
          {
            label: 'EMA',
            data: [],
            borderColor: 'lime',
            fill: false,
          },
        ]
      },
      options: {
        scales: {
          x: {
            ticks: { color: '#fff' },
          },
          y: {
            ticks: { color: '#fff' },
          }
        },
        plugins: {
          legend: {
            labels: { color: '#fff' }
          }
        }
      }
    });

    function startBot() {
      clearInterval(interval);
      updateBot();
      interval = setInterval(updateBot, 60000);
      startCountdown();
    }

    function startCountdown() {
      seconds = 60;
      const countdown = document.getElementById("countdown");
      const timer = setInterval(() => {
        seconds--;
        countdown.textContent = `Prochain signal dans ${seconds}s`;
        if (seconds <= 0) clearInterval(timer);
      }, 1000);
    }

    async function updateBot() {
      const pair = document.getElementById("pairSelect").value.replace("/", "");
      const url = `https://api.twelvedata.com/time_series?symbol=${pair}&interval=1min&outputsize=100&apikey=05d7b73a43a14818905654f8fbbe42f2`;

      const res = await fetch(url);
      const data = await res.json();

      if (!data || !data.values) {
        document.getElementById("signalBox").innerHTML = "<p style='color:red'>Erreur de r√©cup√©ration des donn√©es</p>";
        return;
      }

      const prices = data.values.reverse().map(d => parseFloat(d.close));
      const labels = data.values.map(d => d.datetime.split(" ")[1]);

      const rsi = calculateRSI(prices, 14);
      const ema = calculateEMA(prices, 14);

      chart.data.labels = labels;
      chart.data.datasets[0].data = prices;
      chart.data.datasets[1].data = rsi;
      chart.data.datasets[2].data = ema;
      chart.update();

      const lastRSI = rsi[rsi.length - 1];
      const lastPrice = prices[prices.length - 1];
      const lastEMA = ema[ema.length - 1];

      let signal = "NEUTRE";
      if (lastRSI < 30 && lastPrice > lastEMA) signal = "‚¨ÜÔ∏è UP";
      else if (lastRSI > 70 && lastPrice < lastEMA) signal = "‚¨áÔ∏è DOWN";

      document.getElementById("signalBox").innerText = `Signal IA : ${signal}`;
    }

    function calculateEMA(prices, period) {
      const k = 2 / (period + 1);
      const emaArray = [prices[0]];
      for (let i = 1; i < prices.length; i++) {
        emaArray.push(prices[i] * k + emaArray[i - 1] * (1 - k));
      }
      return emaArray;
    }

    function calculateRSI(prices, period) {
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        let diff = prices[i] - prices[i - 1];
        if (diff >= 0) gains += diff;
        else losses -= diff;
      }
      let avgGain = gains / period;
      let avgLoss = losses / period;
      const rsiArray = [100 - (100 / (1 + (avgGain / avgLoss)))];

      for (let i = period + 1; i < prices.length; i++) {
        let diff = prices[i] - prices[i - 1];
        if (diff >= 0) {
          avgGain = (avgGain * (period - 1) + diff) / period;
          avgLoss = (avgLoss * (period - 1)) / period;
        } else {
          avgGain = (avgGain * (period - 1)) / period;
          avgLoss = (avgLoss * (period - 1) - diff) / period;
        }
        rsiArray.push(100 - (100 / (1 + (avgGain / avgLoss))));
      }
      while (rsiArray.length < prices.length) rsiArray.unshift(null);
      return rsiArray;
    }
  </script>
</body>
</html>
